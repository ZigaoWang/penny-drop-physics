<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will It Hurt? â€” The Penny Drop</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Reset and Global Styles */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            color: #1d1d1f;
            background: linear-gradient(to bottom, #007AFF, #5AC8FA, #A8E6CF, #F0F9FF);
            min-height: 100vh;
        }

        /* Typography System */
        .text-title-1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.6px;
            line-height: 1.1;
        }

        .text-title-2 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.4px;
            line-height: 1.2;
        }

        .text-headline {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.2px;
            line-height: 1.3;
        }

        .text-body {
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.1px;
            line-height: 1.4;
        }

        .text-caption {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0px;
            line-height: 1.3;
        }

        .text-footnote {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 0.1px;
            line-height: 1.2;
            opacity: 0.7;
        }

        /* Color System */
        :root {
            --color-primary: #007AFF;
            --color-secondary: #5AC8FA;
            --color-success: #30D158;
            --color-warning: #FF9F0A;
            --color-danger: #FF3B30;
            --color-surface: rgba(255, 255, 255, 0.8);
            --color-surface-secondary: rgba(255, 255, 255, 0.6);
            --color-surface-tertiary: rgba(255, 255, 255, 0.4);
            --color-text-primary: #1d1d1f;
            --color-text-secondary: #86868b;
            --color-border: rgba(0, 0, 0, 0.1);
            --color-fill: rgba(120, 120, 128, 0.2);
            --blur-strong: blur(40px);
            --blur-medium: blur(20px);
            --shadow-small: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-large: 0 20px 64px rgba(0, 0, 0, 0.25);
        }

        /* Layout Components */
        #scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #container {
            display: grid;
            grid-template-columns: 300px 1fr 390px;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "controls . graphs"
                ". scene graphs"
                "footer footer footer";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            gap: 0;
        }

        /* Glass Panel Component */
        .glass-panel {
            background: var(--color-surface);
            backdrop-filter: var(--blur-medium);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            pointer-events: auto;
        }

        #controls {
            grid-area: controls;
            padding: 24px;
            margin: 24px;
            width: 252px;
            height: fit-content;
        }

        #graphs {
            grid-area: graphs;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            margin: 24px 12px 24px 0;
            width: 312px;
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text-primary);
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.1px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.1px;
            transition: all 0.2s ease;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-control:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Range Input */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--color-fill);
            border-radius: 3px;
            outline: none;
            border: none;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
        }

        /* Removed hover animations */

        .range-value {
            display: inline-block;
            margin-left: 12px;
            padding: 4px 8px;
            background: var(--color-surface-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-primary);
            min-width: 40px;
            text-align: center;
        }

        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.2px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            user-select: none;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
            box-shadow: 0 1px 3px rgba(48, 209, 88, 0.3);
        }

        .btn-warning {
            background: var(--color-warning);
            color: white;
            box-shadow: 0 1px 3px rgba(255, 159, 10, 0.3);
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
            box-shadow: 0 1px 3px rgba(255, 59, 48, 0.3);
        }

        .btn:disabled {
            background: var(--color-fill) !important;
            color: var(--color-text-secondary) !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        /* Chart Container */
        .chart-container {
            background: transparent;
            border-radius: 0;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .chart-container:last-child {
            border-bottom: none;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 12px;
            color: var(--color-text-primary);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.1px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 160px !important;
            border-radius: 8px;
        }

        /* Modal/Verdict */
        #verdict {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-strong);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-large);
            animation: modalAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            color: var(--color-text-primary);
        }

        @keyframes modalAppear {
            from {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background: rgba(120, 120, 128, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text-secondary);
            font-size: 18px;
            transition: all 0.2s ease;
        }

        /* Removed hover animations */

        /* Footer */
        #footer {
            grid-area: footer;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: var(--blur-medium);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 0.1px;
            pointer-events: auto;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        #footer a {
            color: var(--color-secondary);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        /* Removed hover animations */

        /* Custom Inputs */
        #custom-inputs {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            #container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                grid-template-areas:
                    "controls"
                    "graphs"
                    "scene"
                    "footer";
                gap: 0;
            }

            #controls {
                width: auto;
                max-width: none;
                margin: 16px;
            }

            #graphs {
                width: auto;
                margin: 16px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                max-height: none;
            }

            .chart-container {
                flex: 1;
                min-width: 280px;
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            #container {
                grid-template-columns: 1fr;
            }

            #controls, #graphs {
                margin: 12px;
                padding: 20px;
            }

            #graphs {
                flex-direction: column;
            }

            .chart-container {
                max-width: none;
            }

            #verdict {
                margin: 20px;
                max-width: calc(100vw - 40px);
                padding: 24px;
                border-radius: 20px;
            }

            .text-title-1 {
                font-size: 24px;
            }

            .text-title-2 {
                font-size: 20px;
            }

            .btn {
                font-size: 16px;
                min-height: 48px;
            }

            .form-control {
                font-size: 16px;
                padding: 14px 16px;
            }
        }

        @media (max-width: 480px) {
            #controls, #graphs {
                margin: 8px;
                padding: 16px;
            }

            .btn-group {
                gap: 8px;
            }

            #verdict {
                margin: 12px;
                padding: 20px;
            }
        }

        /* Focus and High Contrast Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-contrast: high) {
            :root {
                --color-border: rgba(0, 0, 0, 0.3);
                --color-text-secondary: #666666;
            }

            .form-control:focus {
                border-color: #000000;
                box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.2);
            }
        }

        /* Utility Classes */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <canvas id="scene"></canvas>
    <div id="container">
        <div id="controls" class="glass-panel">
            <div class="form-group">
                <label for="object" class="form-label">Object</label>
                <select id="object" class="form-control">
                    <option value="feather">Feather (0.002 kg, 1 m/s)</option>
                    <option value="raindrop">Raindrop (0.001 kg, 9 m/s)</option>
                    <option value="penny" selected>Penny (0.0025 kg, 11 m/s)</option>
                    <option value="marble">Marble (0.005 kg, 18 m/s)</option>
                    <option value="golf_ball">Golf Ball (0.046 kg, 32 m/s)</option>
                    <option value="tennis_ball">Tennis Ball (0.057 kg, 28 m/s)</option>
                    <option value="hailstone">Large Hailstone (0.02 kg, 25 m/s)</option>
                    <option value="baseball">Baseball (0.145 kg, 45 m/s)</option>
                    <option value="basketball">Basketball (0.62 kg, 20 m/s)</option>
                    <option value="bowling_ball">Bowling Ball (7.26 kg, 35 m/s)</option>
                    <option value="custom">Custom</option>
                </select>
                <div id="custom-inputs">
                    <div class="form-group">
                        <label for="mass" class="form-label">Mass (kg)</label>
                        <input id="mass" type="number" step="0.001" min="0.001" value="0.01" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="terminalV" class="form-label">Terminal Velocity (m/s)</label>
                        <input id="terminalV" type="number" min="1" value="10" class="form-control">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="height" class="form-label">Drop Height</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input id="height" type="range" min="0" max="400" value="100" style="flex: 1;">
                    <input id="height-input" type="number" min="0" max="400" value="100" class="form-control" style="width: 80px; flex: none;">
                    <span style="color: var(--color-text-secondary); font-size: 13px; font-weight: 500;">m</span>
                </div>
            </div>

            <div class="btn-group">
                <button id="start" class="btn btn-success">Start Simulation</button>
                <button id="reset" class="btn btn-warning" disabled>Reset</button>
            </div>
        </div>

        <div id="graphs" class="glass-panel">
            <div class="chart-container">
                <div class="chart-title">Velocity vs Time</div>
                <canvas id="vt-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Distance vs Time</div>
                <canvas id="st-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Height vs Time</div>
                <canvas id="ht-chart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Acceleration vs Time</div>
                <canvas id="at-chart"></canvas>
            </div>
        </div>

        <div id="footer">
            Made by <a href="https://zigao.wang" target="_blank">Zigao Wang</a> â€¢ MIT License â€¢ For educational use only â€¢ Do not drop objects from heights
        </div>
    </div>

    <div id="verdict">
        <button class="modal-close" onclick="document.getElementById('verdict').style.display='none'; resetDrop();" aria-label="Close">Ã—</button>
        <h2 id="verdict-text" class="text-title-1"></h2>
        <div id="stats" class="text-body"></div>
    </div>
    <script>
        const canvas = document.getElementById('scene');
        const ctx = canvas.getContext('2d');
        const g = 9.8;
        const objects = {
            feather: { mass: 0.002, terminalV: 1, color: '#FFFFFF', shape: 'feather' },
            penny: { mass: 0.0025, terminalV: 11, color: '#B87333', shape: 'circle' },
            raindrop: { mass: 0.001, terminalV: 9, color: '#87CEEB', shape: 'circle' },
            marble: { mass: 0.005, terminalV: 18, color: '#4169E1', shape: 'circle' },
            golf_ball: { mass: 0.046, terminalV: 32, color: '#FFFFFF', shape: 'circle' },
            tennis_ball: { mass: 0.057, terminalV: 28, color: '#FFFF00', shape: 'circle' },
            baseball: { mass: 0.145, terminalV: 45, color: '#FFFFFF', shape: 'circle' },
            basketball: { mass: 0.62, terminalV: 20, color: '#FF8C00', shape: 'circle' },
            bowling_ball: { mass: 7.26, terminalV: 35, color: '#000000', shape: 'circle' },
            hailstone: { mass: 0.02, terminalV: 25, color: '#E6E6FA', shape: 'circle' },
            custom: { mass: 0.01, terminalV: 10, color: '#333333', shape: 'circle' }
        };
        const outcomes = [
            { min: 0, max: 1, text: 'Harmless', color: '#4CAF50', anim: 'small flinch' },
            { min: 1, max: 10, text: 'Sting / minor pain', color: '#FFEB3B', anim: 'wince' },
            { min: 10, max: 50, text: 'Possible injury', color: '#FF9800', anim: 'step back' },
            { min: 50, max: 200, text: 'High risk of injury', color: '#F44336', anim: 'fall to one knee' },
            { min: 200, max: Infinity, text: 'Potentially lethal', color: '#B71C1C', anim: 'fall down' }
        ];

        let running = false;
        let t = 0;
        let s = 0;
        let v = 0;
        let a = 0;
        let lastTime = performance.now();
        let lastPushTime = 0;
        let mass, terminalV, h, t_term, s_term, t_impact, v_impact, ke, reached_terminal, objColor, objShape;
        let outcome;
        let particles = [];
        let personAnimFrame = 0;
        let personAnimLevel = 0;
        let clouds = [];

        // Graphs
        let vtData = [];
        let stData = [];
        let htData = [];
        let atData = [];
        let vtChart, stChart, htChart, atChart;

        function initCharts() {
            const chartOptions = {
                animation: { duration: 0 },
                elements: {
                    point: {
                        radius: 0,
                        hoverRadius: 4
                    },
                    line: {
                        tension: 0.2,
                        borderWidth: 3
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Time (s)', color: '#333' },
                        ticks: { color: '#333' },
                        min: 0,
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    },
                    y: {
                        title: { display: true, color: '#333' },
                        ticks: { color: '#333' },
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#333' },
                        display: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            };
            vtChart = new Chart(document.getElementById('vt-chart'), {
                type: 'line',
                data: { datasets: [{
                    label: 'Velocity (m/s)',
                    data: vtData,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    borderWidth: 3
                }] },
                options: chartOptions
            });
            vtChart.options.scales.y.title.text = 'v (m/s)';
            stChart = new Chart(document.getElementById('st-chart'), {
                type: 'line',
                data: { datasets: [{
                    label: 'Distance (m)',
                    data: stData,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    borderWidth: 3
                }] },
                options: chartOptions
            });
            stChart.options.scales.y.title.text = 's (m)';
            htChart = new Chart(document.getElementById('ht-chart'), {
                type: 'line',
                data: { datasets: [{
                    label: 'Height (m)',
                    data: htData,
                    borderColor: '#FF9F0A',
                    backgroundColor: 'rgba(255, 159, 10, 0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    borderWidth: 3
                }] },
                options: chartOptions
            });
            htChart.options.scales.y.title.text = 'h (m)';
            htChart.options.scales.y.min = 0;
            atChart = new Chart(document.getElementById('at-chart'), {
                type: 'line',
                data: { datasets: [{
                    label: 'Acceleration (m/sÂ²)',
                    data: atData,
                    borderColor: '#F44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    borderWidth: 3
                }] },
                options: chartOptions
            });
            atChart.options.scales.y.title.text = 'a (m/sÂ²)';
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            generateClouds();
        }

        function generateClouds() {
            clouds = [];
            for (let i = 0; i < 8; i++) {
                clouds.push({
                    x: Math.random() * (canvas.width + 300) - 150,
                    y: 40 + Math.random() * (canvas.height / 3.5),
                    size: 20 + Math.random() * 45,
                    speed: 0.05 + Math.random() * 0.12,
                    opacity: 0.4 + Math.random() * 0.35,
                    puffCount: 4 + Math.floor(Math.random() * 3),
                    depth: Math.random() > 0.6 ? 'far' : 'near'
                });
            }
        }

        function drawClouds() {
            // Draw far clouds first (background layer)
            clouds.filter(cloud => cloud.depth === 'far').forEach(cloud => {
                ctx.fillStyle = `rgba(255, 255, 255, ${cloud.opacity * 0.6})`;
                drawSingleCloud(cloud, 0.8);
            });

            // Draw near clouds (foreground layer)
            clouds.filter(cloud => cloud.depth === 'near').forEach(cloud => {
                ctx.fillStyle = `rgba(255, 255, 255, ${cloud.opacity})`;
                drawSingleCloud(cloud, 1.0);
            });
        }

        function drawSingleCloud(cloud, scale = 1.0) {
            // Create more realistic, fluffy cloud shape
            const baseSize = cloud.size * scale;

            // Add subtle shadow effect for depth
            if (scale === 1.0) {
                ctx.save();
                ctx.globalAlpha = 0.1;
                ctx.fillStyle = 'rgba(0,0,0,0.3)';

                // Shadow offset
                ctx.beginPath();
                ctx.ellipse(cloud.x + 3, cloud.y + 3, baseSize * 1.4, baseSize * 0.8, 0, 0, 2 * Math.PI);
                ctx.fill();

                ctx.restore();
            }

            // Main cloud body with softer edges
            ctx.save();
            ctx.shadowColor = 'rgba(255,255,255,0.3)';
            ctx.shadowBlur = baseSize * 0.2;

            ctx.beginPath();
            ctx.ellipse(cloud.x, cloud.y, baseSize * 1.4, baseSize * 0.8, 0, 0, 2 * Math.PI);
            ctx.fill();

            // Create more organic puff shapes
            const puffPositions = [
                { x: -0.7, y: 0.1, size: 0.9, skew: 0.8 },
                { x: 0.7, y: -0.1, size: 0.8, skew: 0.9 },
                { x: -0.2, y: -0.5, size: 0.7, skew: 0.7 },
                { x: 0.3, y: -0.4, size: 0.6, skew: 0.8 },
                { x: -0.5, y: -0.2, size: 0.5, skew: 0.6 },
                { x: 0.5, y: 0.2, size: 0.6, skew: 0.7 }
            ];

            puffPositions.slice(0, cloud.puffCount).forEach((puff, i) => {
                ctx.beginPath();
                ctx.ellipse(
                    cloud.x + baseSize * puff.x,
                    cloud.y + baseSize * puff.y,
                    baseSize * puff.size * 0.85,
                    baseSize * puff.size * puff.skew * 0.6,
                    Math.sin(i) * 0.3,
                    0, 2 * Math.PI
                );
                ctx.fill();
            });

            ctx.restore();
        }

        function drawTower() {
            const towerWidth = 140;
            const towerX = canvas.width / 2 - towerWidth / 2;
            const towerTop = 30;
            const towerHeight = canvas.height - 80;

            // Tower body with gradient
            const gradient = ctx.createLinearGradient(towerX, towerTop, towerX + towerWidth, towerTop);
            gradient.addColorStop(0, '#A9A9A9');
            gradient.addColorStop(1, '#808080');
            ctx.fillStyle = gradient;
            ctx.fillRect(towerX, towerTop, towerWidth, towerHeight);

            // Windows
            ctx.fillStyle = 'rgba(173, 216, 230, 0.6)';
            for (let floor = 0; floor < 25; floor++) {
                for (let win = 0; win < 5; win++) {
                    ctx.fillRect(towerX + 15 + win * 22, towerTop + 15 + floor * (towerHeight / 25), 18, 8);
                }
            }

            // Antenna
            ctx.strokeStyle = '#696969';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, towerTop);
            ctx.lineTo(canvas.width / 2, towerTop - 40);
            ctx.stroke();
        }

        function drawGround() {
            const gradient = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height - 30);
            gradient.addColorStop(0, '#228B22');
            gradient.addColorStop(1, '#006400');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, canvas.height - 100, canvas.width, 70);
        }

        function drawScene() {
            // Complete canvas reset with all state cleanup
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.shadowColor = 'transparent';
            ctx.filter = 'none';
            ctx.lineWidth = 1;
            ctx.lineCap = 'butt';
            ctx.lineJoin = 'miter';
            ctx.miterLimit = 10;

            // Draw sky gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#4A90E2');
            gradient.addColorStop(0.3, '#87CEEB');
            gradient.addColorStop(0.7, '#B6E5F5');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawClouds();
            drawTower();
            drawGround();

            // People - just one person in the center
            drawPerson(canvas.width / 2, canvas.height - 130, !running && t >= t_impact);

            ctx.restore();

            // Object
            if (running || (!running && t > 0)) {
                const objX = canvas.width / 2;
                const objY = 30 + (s / h) * (canvas.height - 180);
                ctx.fillStyle = objColor || 'black';
                if (objShape === 'feather') {
                    ctx.save();
                    ctx.translate(objX, objY);
                    ctx.rotate(Math.PI / 4);
                    ctx.beginPath();
                    ctx.moveTo(0, -15);
                    ctx.lineTo(0, 15);
                    ctx.strokeStyle = '#DDD';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    for (let i = -10; i <= 10; i += 5) {
                        ctx.beginPath();
                        ctx.moveTo(0, i);
                        ctx.lineTo(8, i - 4);
                        ctx.stroke();
                    }
                    ctx.restore();
                } else {
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 5;
                    ctx.shadowOffsetY = 2;
                    ctx.beginPath();
                    ctx.arc(objX, Math.min(objY, canvas.height - 122), 10, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.restore();
                }

                // Speed label
                if (running) {
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 2;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    ctx.font = '16px system-ui';
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    const speedText = `${v.toFixed(1)} m/s`;
                    ctx.fillText(speedText, objX + 20, objY + 5);
                    ctx.restore();
                }
            }

            // Particles on impact
            if (particles.length > 0) {
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.3;
                    p.life -= 1;
                    if (p.life > 0) {
                        ctx.fillStyle = `rgba(255, 215, 0, ${p.life / 40})`;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                });
                particles = particles.filter(p => p.life > 0);
            }

            if (!running && t >= t_impact && personAnimFrame < 20) {
                personAnimFrame += 0.3;
            }
        }

        function drawPerson(x, y, animate) {
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 4;
            ctx.fillStyle = '#444';

            let bodyAngle = 0;
            let armAngleL = -25;
            let armAngleR = 25;
            let legAngleL = -8;
            let legAngleR = 8;
            let headAngle = 0;
            let stepBack = 0;
            let kneeBend = 0;

            if (animate) {
                const animProgress = Math.min(personAnimFrame / 10, 1);
                switch (personAnimLevel) {
                    case 0:
                        armAngleL = -25 + Math.sin(personAnimFrame * 0.6) * 12;
                        armAngleR = 25 - Math.sin(personAnimFrame * 0.6) * 12;
                        break;
                    case 1:
                        headAngle = Math.sin(personAnimFrame * 0.4) * 6;
                        bodyAngle = Math.sin(personAnimFrame * 0.4) * 4;
                        break;
                    case 2:
                        stepBack = animProgress * 25;
                        legAngleL = -8 - animProgress * 25;
                        legAngleR = 8 + animProgress * 25;
                        break;
                    case 3:
                        kneeBend = animProgress * 25;
                        bodyAngle = animProgress * 20;
                        y += kneeBend;
                        legAngleR = 50 * animProgress;
                        break;
                    case 4:
                        bodyAngle = 90 * animProgress;
                        y += 35 * animProgress;
                        armAngleL = -25 + 70 * animProgress;
                        armAngleR = 25 + 70 * animProgress;
                        legAngleL = 0;
                        legAngleR = 0;
                        break;
                }
            }

            ctx.save();
            ctx.translate(x + 12 + stepBack, y + 25);
            ctx.rotate(bodyAngle * Math.PI / 180);
            ctx.translate(-(x + 12 + stepBack), -(y + 25));

            // Head
            ctx.save();
            ctx.translate(x + 12, y + 8);
            ctx.rotate(headAngle * Math.PI / 180);
            ctx.beginPath();
            ctx.arc(0, 0, 14, 0, 2 * Math.PI);
            ctx.fill();
            ctx.restore();

            // Body
            ctx.beginPath();
            ctx.moveTo(x + 12, y + 20);
            ctx.lineTo(x + 12, y + 50);
            ctx.stroke();

            // Arms
            ctx.save();
            ctx.translate(x + 12, y + 30);
            ctx.rotate(armAngleL * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-18, 0);
            ctx.stroke();
            ctx.restore();

            ctx.save();
            ctx.translate(x + 12, y + 30);
            ctx.rotate(armAngleR * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(18, 0);
            ctx.stroke();
            ctx.restore();

            // Legs
            ctx.save();
            ctx.translate(x + 12, y + 50 + kneeBend);
            ctx.rotate(legAngleL * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-12, 25 - kneeBend / 2);
            ctx.stroke();
            ctx.restore();

            ctx.save();
            ctx.translate(x + 12, y + 50 + kneeBend);
            ctx.rotate(legAngleR * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(12, 25 - kneeBend / 2);
            ctx.stroke();
            ctx.restore();

            ctx.restore();
        }

        function startDrop() {
            if (running) {
                // Pause the current simulation
                running = false;
                document.getElementById('start').textContent = 'Start Simulation';
                document.getElementById('start').className = 'btn btn-success';
                return;
            }

            // If we have existing data, continue from where we left off
            if (t > 0 && s < h) {
                running = true;
                document.getElementById('start').textContent = 'Stop Simulation';
                document.getElementById('start').className = 'btn btn-danger';
                lastTime = performance.now();
                return;
            }

            // Start new simulation
            const objType = document.getElementById('object').value;
            let selectedObj;
            if (objType === 'custom') {
                mass = parseFloat(document.getElementById('mass').value);
                terminalV = parseFloat(document.getElementById('terminalV').value);
                objColor = '#333333';
                objShape = 'circle';
            } else {
                selectedObj = objects[objType];
                mass = selectedObj.mass;
                terminalV = selectedObj.terminalV;
                objColor = selectedObj.color;
                objShape = selectedObj.shape;
            }
            h = parseFloat(document.getElementById('height').value);
            if (isNaN(mass) || isNaN(terminalV) || mass <= 0 || terminalV <= 0 || h <= 0) {
                alert('Invalid inputs. Height must be greater than 0.');
                return;
            }

            t_term = terminalV / g;
            s_term = (terminalV ** 2) / (2 * g);
            if (h <= s_term) {
                t_impact = Math.sqrt(2 * h / g);
                v_impact = Math.sqrt(2 * g * h);
            } else {
                t_impact = t_term + (h - s_term) / terminalV;
                v_impact = terminalV;
            }
            ke = 0.5 * mass * (v_impact ** 2);
            reached_terminal = h > s_term;

            outcome = outcomes.find(o => ke >= o.min && ke < o.max);
            personAnimLevel = outcomes.indexOf(outcome);

            running = true;
            t = 0;
            s = 0;
            v = 0;
            a = g; // Initial acceleration is g
            vtData = [{ x: 0, y: 0 }]; // Start with initial point at t=0
            stData = [{ x: 0, y: 0 }];
            htData = [{ x: 0, y: h }]; // Start at full height
            atData = [{ x: 0, y: g }];
            particles = [];
            personAnimFrame = 0;

            // Set fixed y-axis for height chart
            htChart.options.scales.y.max = h;

            document.getElementById('start').textContent = 'Stop Simulation';
            document.getElementById('start').className = 'btn btn-danger';
            document.getElementById('start').disabled = false;
            document.getElementById('reset').disabled = false;
            document.getElementById('object').disabled = true;
            document.getElementById('height').disabled = true;
            document.getElementById('height-input').disabled = true;
            document.getElementById('verdict').style.display = 'none';
            lastTime = performance.now();
            lastPushTime = 0;
        }

        function resetDrop() {
            running = false;
            document.getElementById('start').textContent = 'Start Simulation';
            document.getElementById('start').className = 'btn btn-success';
            document.getElementById('start').disabled = false;
            document.getElementById('reset').disabled = true;
            document.getElementById('object').disabled = false;
            document.getElementById('height').disabled = false;
            document.getElementById('height-input').disabled = false;
            document.getElementById('verdict').style.display = 'none';
            t = 0;
            vtData = [];
            stData = [];
            htData = [];
            atData = [];
            vtChart.options.scales.x.max = undefined;
            stChart.options.scales.x.max = undefined;
            htChart.options.scales.x.max = undefined;
            htChart.options.scales.y.max = undefined;
            atChart.options.scales.x.max = undefined;
            vtChart.update();
            stChart.update();
            htChart.update();
            atChart.update();
            particles = [];
            personAnimFrame = 0;
        }

        function animate(time) {
            const dt = (time - lastTime) / 1000;
            lastTime = time;

            // Always animate clouds
            clouds.forEach(cloud => {
                cloud.x += cloud.speed;
                if (cloud.x > canvas.width + cloud.size * 2) {
                    cloud.x = -cloud.size * 2;
                    cloud.y = 50 + Math.random() * (canvas.height / 4);
                }
            });

            if (running) {
                t += dt;

                if (t <= t_term) {
                    v = g * t;
                    s = 0.5 * g * (t ** 2);
                    a = g;
                } else {
                    v = terminalV;
                    s = s_term + terminalV * (t - t_term);
                    a = 0;
                }

                if (t - lastPushTime >= 0.05) {  // Downsample to every 0.05s
                    vtData.push({ x: t, y: v });
                    stData.push({ x: t, y: s });
                    htData.push({ x: t, y: h - s }); // Height above ground decreases as distance increases
                    atData.push({ x: t, y: a });
                    lastPushTime = t;
                }

                vtChart.data.datasets[0].data = vtData;
                stChart.data.datasets[0].data = stData;
                htChart.data.datasets[0].data = htData;
                atChart.data.datasets[0].data = atData;
                vtChart.update('none');
                stChart.update('none');
                htChart.update('none');
                atChart.update('none');

                if (s >= h) {
                    running = false;
                    document.getElementById('start').textContent = 'Start Simulation';
                    document.getElementById('start').className = 'btn btn-success';
                    // Only show particles for harmless or minor impacts (ke < 50J)
                    if (ke < 50) {
                        for (let i = 0; i < 40; i++) {
                            particles.push({
                                x: canvas.width / 2,
                                y: canvas.height - 122,
                                vx: (Math.random() - 0.5) * 20,
                                vy: (Math.random() - 0.5) * 20 - 12,
                                life: 40 + Math.random() * 30
                            });
                        }
                    }

                    // Delay verdict screen to show animation
                    setTimeout(() => {
                        document.getElementById('verdict-text').textContent = `${outcome.text} (${ke.toFixed(1)} J)`;
                        document.getElementById('verdict-text').style.color = outcome.color;

                        // Create clean, Apple-inspired calculation display
                        const cleanCalculation = `
                            <div style="text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;">

                                <div style="background: rgba(0, 122, 255, 0.08); border-radius: 16px; padding: 24px; margin: 24px 0; border: 1px solid rgba(0, 122, 255, 0.2);">
                                    <div style="font-size: 19px; font-weight: 600; margin-bottom: 20px; color: #007AFF; letter-spacing: -0.3px;">Parameters</div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 15px; color: #1d1d1f;">
                                        <div style="text-align: left;">
                                            <div style="color: #007AFF; font-weight: 600; margin-bottom: 12px; font-size: 17px; letter-spacing: -0.2px;">Object</div>
                                            <div style="margin-bottom: 8px; font-weight: 400;">Height: <span style="font-weight: 600;">${h} m</span></div>
                                            <div style="margin-bottom: 8px; font-weight: 400;">Mass: <span style="font-weight: 600;">${mass.toFixed(3)} kg</span></div>
                                            <div style="font-weight: 400;">Terminal velocity: <span style="color: #FF9F0A; font-weight: 600;">${terminalV} m/s</span></div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="color: #30D158; font-weight: 600; margin-bottom: 12px; font-size: 17px; letter-spacing: -0.2px;">Results</div>
                                            <div style="margin-bottom: 8px; font-weight: 400;">Fall time: <span style="font-weight: 600;">${t_impact.toFixed(3)} s</span></div>
                                            <div style="margin-bottom: 8px; font-weight: 400;">Terminal reached: <span style="color: ${reached_terminal ? '#30D158' : '#FF3B30'}; font-weight: 600;">${reached_terminal ? 'Yes' : 'No'}</span></div>
                                            <div style="font-weight: 400;">Impact speed: <span style="color: #FF3B30; font-weight: 600;">${v_impact.toFixed(3)} m/s</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div style="background: rgba(48, 209, 88, 0.08); border-radius: 16px; padding: 24px; margin: 24px 0; border: 1px solid rgba(48, 209, 88, 0.2);">
                                    <div style="font-size: 19px; font-weight: 600; margin-bottom: 20px; color: #30D158; letter-spacing: -0.3px;">Impact Velocity</div>

                                    ${reached_terminal ?
                                        `<div style="font-size: 22px; margin: 16px 0; letter-spacing: -0.4px; color: #1d1d1f;">
                                            <span style="color: #007AFF; font-weight: 600;">v</span><sub style="font-size: 16px;">impact</sub> = <span style="color: #FF9F0A; font-weight: 600;">terminal velocity</span>
                                        </div>
                                        <div style="font-size: 28px; color: #30D158; font-weight: 700; margin: 20px 0; letter-spacing: -0.5px;">
                                            ${v_impact.toFixed(3)} m/s
                                        </div>`
                                        :
                                        `<div style="font-size: 22px; margin: 16px 0; letter-spacing: -0.4px; color: #1d1d1f;">
                                            <span style="color: #007AFF; font-weight: 600;">v</span> = âˆš(<span style="color: #FF3B30; font-weight: 600;">2</span><span style="color: #30D158; font-weight: 600;">g</span><span style="color: #FF9F0A; font-weight: 600;">h</span>)
                                        </div>
                                        <div style="font-size: 17px; margin: 16px 0; color: #86868b; font-weight: 400;">
                                            âˆš(<span style="color: #FF3B30; font-weight: 600;">2</span> Ã— <span style="color: #30D158; font-weight: 600;">9.8 m/sÂ²</span> Ã— <span style="color: #FF9F0A; font-weight: 600;">${h} m</span>) = <span style="color: #007AFF; font-weight: 600;">${v_impact.toFixed(3)} m/s</span>
                                        </div>
                                        <div style="font-size: 28px; color: #30D158; font-weight: 700; margin: 20px 0; letter-spacing: -0.5px;">
                                            ${v_impact.toFixed(3)} m/s
                                        </div>`
                                    }
                                </div>

                                <div style="background: rgba(255, 159, 10, 0.08); border-radius: 16px; padding: 24px; margin: 0px 0; border: 1px solid rgba(255, 159, 10, 0.2);">
                                    <div style="font-size: 19px; font-weight: 600; margin-bottom: 20px; color: #FF9F0A; letter-spacing: -0.3px;">Kinetic Energy</div>

                                    <div style="font-size: 22px; margin: 16px 0; letter-spacing: -0.4px; color: #1d1d1f;">
                                        <span style="color: #007AFF; font-weight: 600;">KE</span> = <span style="color: #FF3B30; font-weight: 600;">Â½</span><span style="color: #30D158; font-weight: 600;">m</span><span style="color: #007AFF; font-weight: 600;">v</span><span style="color: #1d1d1f;">Â²</span>
                                    </div>

                                    <div style="font-size: 17px; margin: 16px 0; color: #86868b; font-weight: 400;">
                                        <span style="color: #FF3B30; font-weight: 600;">0.5</span> Ã— <span style="color: #30D158; font-weight: 600;">${mass.toFixed(4)} kg</span> Ã— (<span style="color: #007AFF; font-weight: 600;">${v_impact.toFixed(3)} m/s</span>)Â² = <span style="color: #FF9F0A; font-weight: 600;">${ke.toFixed(3)} J</span>
                                    </div>

                                    <div style="font-size: 28px; color: #FF9F0A; font-weight: 700; margin: 20px 0; letter-spacing: -0.5px;">
                                        ${ke.toFixed(3)} J
                                    </div>

                                    <div style="font-size: 13px; color: #86868b; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(134, 134, 139, 0.2); font-weight: 400;">
                                        Reference: Human skull fracture threshold â‰ˆ 68 J<br>
                                        <span style="font-size: 11px; opacity: 0.8;">Yoganandan, N et al. "Biomechanics of skull fracture." Journal of neurotrauma vol. 12,4 (1995): 659-68. doi:10.1089/neu.1995.12.659</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('stats').innerHTML = cleanCalculation;
                        document.getElementById('verdict').style.display = 'block';
                    }, 500); // 0.5 second delay to show animation
                }
            }

            drawScene();
            requestAnimationFrame(animate);
        }

        // Event listeners
        window.addEventListener('resize', () => {
            resizeCanvas();
            drawScene();
        });
        document.getElementById('object').addEventListener('change', (e) => {
            const custom = e.target.value === 'custom';
            document.getElementById('custom-inputs').style.display = custom ? 'block' : 'none';
        });
        document.getElementById('height').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('height-input').value = value;
        });
        document.getElementById('height-input').addEventListener('input', (e) => {
            const value = Math.max(0, Math.min(400, parseFloat(e.target.value) || 0));
            e.target.value = value;
            document.getElementById('height').value = value;
        });
        document.getElementById('start').addEventListener('click', startDrop);
        document.getElementById('reset').addEventListener('click', resetDrop);

        // Init
        resizeCanvas();
        initCharts();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
